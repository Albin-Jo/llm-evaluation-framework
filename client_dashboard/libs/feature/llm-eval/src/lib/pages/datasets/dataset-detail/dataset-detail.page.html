<!-- Path: libs/feature/llm-eval/src/lib/pages/datasets/dataset-detail/dataset-detail.page.html -->
<div class="dataset-detail-container">
  <!-- Back Navigation -->
  <div class="back-navigation">
    <button class="back-button" (click)="goBack($event)">
      <span class="back-icon">‚Üê</span>
      <span>Back to Datasets</span>
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading dataset details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !dataset" class="error-container">
    <div class="error-icon">‚ùå</div>
    <h2>Dataset Not Found</h2>
    <p>The requested dataset could not be found or may have been deleted.</p>
    <div class="error-actions">
      <button class="primary-button" (click)="goBack($event)">
        Back to Datasets
      </button>
    </div>
  </div>

  <!-- Dataset Details -->
  <div *ngIf="!isLoading && dataset" class="dataset-details">
    <!-- Header Section -->
    <div class="detail-header">
      <div class="header-content">
        <h1 class="detail-title" *ngIf="!isEditing">{{ dataset?.name }}</h1>
        <input
          *ngIf="isEditing"
          type="text"
          class="detail-title-input"
          placeholder="Dataset Name"
          [(ngModel)]="editingDataset.name"
          [class.is-invalid]="!editingDataset.name">
        <div class="detail-badges">
          <span class="status-badge" [ngClass]="statusClass">{{ statusText }}</span>
        </div>
      </div>
      <div class="header-actions">
        <ng-container *ngIf="!isEditing">
          <button class="outline-button edit-button" (click)="startEditing()">
            Edit
          </button>
          <button class="outline-button delete-button" (click)="deleteDataset($event)">
            Delete
          </button>
        </ng-container>
        <ng-container *ngIf="isEditing">
          <button class="outline-button cancel-button" (click)="cancelEditing()">
            Cancel
          </button>
          <button class="primary-button save-button" [disabled]="!canSave()" (click)="saveChanges()">
            Save Changes
          </button>
        </ng-container>
      </div>
    </div>

    <!-- Dataset Information -->
    <div class="content-card info-card">
      <h2 class="card-title">Dataset Information</h2>

      <!-- Description -->
      <div class="info-group">
        <div class="info-label">Description</div>
        <div class="info-value" *ngIf="!isEditing">{{ dataset?.description || 'No description provided' }}</div>
        <textarea
          *ngIf="isEditing"
          class="info-textarea"
          placeholder="Enter dataset description"
          [(ngModel)]="editingDataset.description"></textarea>
      </div>

      <!-- Metadata Grid -->
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Dataset Type</div>
          <div class="info-value">{{ dataset?.type || 'User Query' }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Created</div>
          <div class="info-value">{{ formatDate(dataset?.createdAt) }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Last Updated</div>
          <div class="info-value">{{ formatDate(dataset?.updatedAt) }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Document Count</div>
          <div class="info-value">{{ dataset?.documentCount || 0 }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Total Size</div>
          <div class="info-value">{{ formattedSize }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Avg. Length</div>
          <div class="info-value">{{ getAverageDocLength() }}<span class="info-unit">tokens</span></div>
        </div>
      </div>

      <!-- Tags Section -->
      <div class="info-group">
        <div class="info-label">Tags</div>
        <div class="tags-container">
          <ng-container *ngIf="!isEditing">
            <span *ngFor="let tag of dataset?.tags || []" class="tag-pill">{{ tag }}</span>
            <span *ngIf="!dataset?.tags || dataset?.tags.length === 0" class="no-tags">No tags added</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <button
              *ngFor="let tag of availableTags"
              type="button"
              class="tag-button"
              [class.active]="editingDataset.tags?.includes(tag)"
              (click)="toggleTag(tag)">
              {{ tag }}
            </button>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Documents Section -->
    <div class="content-card documents-card">
      <h2 class="card-title">Documents</h2>

      <!-- Upload in Progress -->
      <div *ngIf="isUploading" class="upload-progress-container">
        <div class="progress-bar">
          <div class="progress-bar-inner" [style.width.%]="uploadProgress"></div>
        </div>
        <p>Uploading documents: {{ uploadProgress }}%</p>
      </div>

      <!-- No Documents State -->
      <div *ngIf="!isUploading && documents.length === 0" class="empty-documents">
        <div class="empty-icon">üìÑ</div>
        <p>No documents found in this dataset</p>
        <button class="primary-button" (click)="uploadDocuments($event)">
          Upload Document
        </button>
      </div>

      <!-- Documents List -->
      <div *ngIf="!isUploading && documents.length > 0" class="document-list-container">
        <!-- Documents List Header -->
        <div class="document-list-header">
          <div class="filename-col">FILENAME</div>
          <div class="format-col">FORMAT</div>
          <div class="size-col">SIZE</div>
          <div class="date-col">ADDED</div>
          <div class="actions-col">ACTIONS</div>
        </div>

        <!-- Documents List Rows -->
        <div class="document-list-body">
          <div *ngFor="let doc of documents" class="document-list-row">
            <div class="filename-col">{{ doc.name }}</div>
            <div class="format-col">{{ getDocumentFormat(doc) }}</div>
            <div class="size-col">{{ getDocumentSize(doc) }}</div>
            <div class="date-col">{{ formatDate(doc.createdAt) }}</div>
            <div class="actions-col">
              <button class="action-button view-button" (click)="previewDocument(doc)">
                View
              </button>
              <button class="action-button delete-button" (click)="confirmDeleteDocument($event, doc.id)">
                Delete
              </button>
            </div>
          </div>
        </div>

        <!-- Upload More Button -->
        <div class="document-list-footer">
          <button class="primary-button" (click)="uploadDocuments($event)">
            Upload More Documents
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Document Preview Modal -->
  <div *ngIf="previewingDocument" class="document-preview-modal">
    <div class="modal-backdrop" (click)="closeDocumentPreview()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Document Preview: {{ currentPreviewDocument?.name }}</h3>
        <button class="close-button" (click)="closeDocumentPreview()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="preview-content">
          <div *ngIf="isLoadingPreview" class="preview-loading">
            <div class="spinner"></div>
            <p>Loading document content...</p>
          </div>
          <div *ngIf="!isLoadingPreview && documentPreviewError" class="preview-error">
            <div class="error-icon">‚ùå</div>
            <p>{{ documentPreviewError }}</p>
          </div>
          <div *ngIf="!isLoadingPreview && !documentPreviewError" class="preview-container" [ngSwitch]="getDocumentFormat(currentPreviewDocument)">
            <!-- CSV Preview -->
            <div *ngSwitchCase="'CSV'" class="csv-preview">
              <div class="csv-table">
                <div class="csv-header">
                  <div *ngFor="let header of documentPreviewHeaders" class="csv-cell">
                    {{ header }}
                  </div>
                </div>
                <div *ngFor="let row of documentPreviewData" class="csv-row">
                  <div *ngFor="let header of documentPreviewHeaders" class="csv-cell">
                    {{ row[header] }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Text Preview -->
            <div *ngSwitchCase="'TXT'" class="text-preview">
              <pre>{{ documentPreviewContent }}</pre>
            </div>

            <!-- JSON Preview -->
            <div *ngSwitchCase="'JSON'" class="json-preview">
              <pre>{{ formatJson(documentPreviewContent) }}</pre>
            </div>

            <!-- Fallback Preview -->
            <div *ngSwitchDefault class="fallback-preview">
              <p>Preview not available for this file type.</p>
              <p>You can download the file to view its contents.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="outline-button" (click)="downloadDocument()">
          Download
        </button>
        <button class="primary-button" (click)="closeDocumentPreview()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>