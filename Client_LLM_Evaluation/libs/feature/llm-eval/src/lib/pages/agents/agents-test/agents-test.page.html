<!-- Path: libs/feature/llm-eval/src/lib/pages/agents/agents-test/agents-test.page.html -->
<div class="agent-test-container">
  <!-- Header Section -->
  <div class="test-header">
    <button class="back-button" (click)="onBackClick()">
      <span class="back-icon">‚Üê</span> Back to Agent
    </button>

    <div class="title-container">
      <h1 class="page-title">Test Agent</h1>
      <p *ngIf="agent" class="agent-name">
        {{ agent.name }}
        <span class="domain-badge">{{ agent.domain }}</span>
        <span class="status-badge" [ngClass]="agent.is_active ? 'active' : 'inactive'">
          {{ agent.is_active ? 'Active' : 'Inactive' }}
        </span>
      </p>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading agent details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <div class="error-icon">‚ùå</div>
    <p>{{ error }}</p>
    <qrac-button
      *ngIf="agentId"
      label="Try Again"
      type="secondary"
      (buttonClick)="loadAgent(agentId)">
    </qrac-button>
  </div>

  <!-- Test Interface -->
  <div *ngIf="agent && !isLoading" class="test-interface">
    <div class="left-panel">
      <!-- Test Form -->
      <div class="test-form-container">
        <form [formGroup]="testForm" (ngSubmit)="onSubmit()" class="test-form">
          <div class="form-section">
            <h2 class="section-title">Test Input</h2>

            <div class="form-row">
              <div class="form-field">
                <qrac-textbox
                  label="Query"
                  controlName="query"
                  formControlName="query"
                  placeholder="Enter your query or question"
                  [required]="true">
                </qrac-textbox>
                <div *ngIf="hasError('query')" class="error-message">
                  {{ getErrorMessage('query') }}
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <qrac-text-area
                  label="Context (Optional)"
                  controlName="context"
                  formControlName="context"
                  placeholder="Enter context information"
                  [rows]="4">
                </qrac-text-area>
                <div class="field-hint">
                  Provide any relevant context for the agent to use when processing your query
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label class="param-label">Additional Parameters (JSON)</label>
                <div class="parameters-container">
                  <qrac-text-area
                    controlName="parameters"
                    formControlName="parameters"
                    placeholder="Enter additional parameters as JSON"
                    [rows]="3">
                  </qrac-text-area>
                  <button
                    type="button"
                    class="format-button"
                    title="Format JSON"
                    (click)="formatJsonInput()">
                    Format
                  </button>
                </div>
                <div class="field-hint">
                  Optional parameters in JSON format (e.g., {{ "{" }}"temperature": 0.7{{ "}" }})
                </div>
                <div *ngIf="jsonError" class="error-message">
                  {{ jsonError }}
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="history-button"
                [class.active]="showHistory"
                (click)="toggleHistory()">
                <span class="history-icon">‚ü≤</span>
                {{ showHistory ? 'Hide History' : 'Show History' }}
              </button>
              <button type="submit" class="test-button" [disabled]="testForm.invalid || isTesting">
                <span *ngIf="isTesting" class="spinner-small"></span>
                {{ isTesting ? 'Testing...' : 'Run Test' }}
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Test History -->
      <div *ngIf="showHistory && testHistory.length > 0" class="history-container">
        <div class="history-header">
          <h3 class="history-title">Test History</h3>
          <button class="clear-history-button" (click)="clearTestHistory()">Clear</button>
        </div>
        <div class="history-list">
          <div
            *ngFor="let test of testHistory"
            class="history-item"
            [class.success]="test.success"
            [class.error]="!test.success"
            (click)="loadFromHistory(test)">
            <div class="history-item-content">
              <span class="history-query">{{ truncateQuery(test.query) }}</span>
              <span class="history-time">{{ formatTimestamp(test.timestamp) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Results -->
    <div class="right-panel">
      <div *ngIf="testResult" class="test-results-container">
        <div class="results-header">
          <h2 class="section-title">
            Test Results
            <span class="result-status" [ngClass]="testSuccess ? 'success' : 'error'">
              {{ testSuccess ? 'Success' : 'Error' }}
            </span>
          </h2>
        </div>

        <div class="results-content">
          <app-simple-json-viewer [json]="testResult"></app-simple-json-viewer>
        </div>
      </div>

      <!-- Placeholder when no test has been run -->
      <div *ngIf="!testResult && !isTesting" class="no-results-container">
        <div class="no-results-icon">üîç</div>
        <h3>No test results yet</h3>
        <p>Submit a query to test this agent</p>
      </div>
    </div>
  </div>
</div>