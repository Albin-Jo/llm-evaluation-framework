<div class="evaluation-detail-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="back-navigation">
      <a routerLink="/app/evaluations" class="back-link">
        <span class="back-icon">‚Üê</span> Back to Evaluations
      </a>
    </div>

    <div class="title-actions">
      <div class="title-section">
        <h1 class="page-title" *ngIf="evaluation">{{ evaluation.name }}</h1>
        <div class="status-badge-container" *ngIf="evaluation">
          <span
            class="status-badge"
            [ngClass]="getStatusBadgeClass(evaluation.status)"
          >
            {{ evaluation.status }}
          </span>
        </div>
      </div>

      <div class="action-buttons" *ngIf="evaluation">
        <button
          *ngIf="canStartEvaluation()"
          class="action-button start-button"
          (click)="startEvaluation()"
        >
          Start Evaluation
        </button>
        <button
          *ngIf="canCancelEvaluation()"
          class="action-button cancel-button"
          (click)="cancelEvaluation()"
        >
          Cancel Evaluation
        </button>
        <button class="action-button edit-button" (click)="editEvaluation()">
          Edit
        </button>
        <button
          class="action-button report-button"
          (click)="navigateToCreateReport()"
        >
          Generate Report
        </button>
        <button
          class="action-button delete-button"
          (click)="deleteEvaluation()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading evaluation details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <div class="error-icon">‚ùå</div>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadEvaluationData(evaluationId)">
      Try Again
    </button>
  </div>

  <!-- Evaluation Content -->
  <div *ngIf="evaluation && !isLoading" class="evaluation-content">
    <!-- Progress Bar (for running evaluations) -->
    <div
      *ngIf="evaluation.status === EvaluationStatus.RUNNING && evaluationProgress"
      class="progress-section"
    >
      <div class="progress-header">
        <h3>Evaluation Progress</h3>
        <span class="progress-percentage"
          >{{ evaluationProgress.percentage_complete }}%</span
        >
      </div>
      <div class="progress-bar-container">
        <div
          class="progress-bar"
          [style.width.%]="evaluationProgress.percentage_complete"
        ></div>
      </div>
      <div class="progress-details">
        <span
          >{{ evaluationProgress.processed_items }} of {{
          evaluationProgress.total_items }} items processed</span
        >
        <span *ngIf="evaluationProgress.estimated_completion"
          >Est. completion: {{
          formatDate(evaluationProgress.estimated_completion) }}</span
        >
      </div>
    </div>

    <!-- Information Cards -->
    <div class="info-cards">
      <!-- Basic Information Card -->
      <div class="info-card">
        <h3 class="card-title">Evaluation Details</h3>
        <div class="card-content">
          <div class="info-row">
            <span class="info-label">ID:</span>
            <span class="info-value">{{ evaluation.id }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Method:</span>
            <span class="info-value">{{ evaluation.method }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Created:</span>
            <span class="info-value"
              >{{ formatDate(evaluation.created_at) }}</span
            >
          </div>
          <div class="info-row">
            <span class="info-label">Description:</span>
            <span class="info-value description-value"
              >{{ evaluation.description || 'No description provided' }}</span
            >
          </div>
        </div>
      </div>

      <!-- Timing Information Card -->
      <div class="info-card">
        <h3 class="card-title">Timing Information</h3>
        <div class="card-content">
          <div class="info-row">
            <span class="info-label">Start Time:</span>
            <span class="info-value"
              >{{ formatDate(evaluation.start_time) }}</span
            >
          </div>
          <div class="info-row">
            <span class="info-label">End Time:</span>
            <span class="info-value"
              >{{ formatDate(evaluation.end_time) }}</span
            >
          </div>
          <div class="info-row">
            <span class="info-label">Duration:</span>
            <span class="info-value"
              >{{ formatDuration(evaluation.start_time, evaluation.end_time)
              }}</span
            >
          </div>
          <div class="info-row">
            <span class="info-label">Last Updated:</span>
            <span class="info-value"
              >{{ formatDate(evaluation.updated_at) }}</span
            >
          </div>
        </div>
      </div>

      <!-- Related Items Card -->
      <div class="info-card">
        <h3 class="card-title">Related Items</h3>
        <div class="card-content">
          <div class="info-row clickable" (click)="viewAgent()">
            <span class="info-label">Agent:</span>
            <span class="info-value link-value"
              >{{ evaluation.agent?.name || evaluation.agent_id }}</span
            >
          </div>
          <div class="info-row clickable" (click)="viewDataset()">
            <span class="info-label">Dataset:</span>
            <span class="info-value link-value"
              >{{ evaluation.dataset?.name || evaluation.dataset_id }}</span
            >
          </div>
          <div class="info-row clickable" (click)="viewPrompt()">
            <span class="info-label">Prompt:</span>
            <span class="info-value link-value"
              >{{ evaluation.prompt?.name || evaluation.prompt_id }}</span
            >
          </div>
          <div class="info-row" *ngIf="evaluation.pass_threshold">
            <span class="info-label">Pass Threshold:</span>
            <span class="info-value">{{ evaluation.pass_threshold }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Metrics Section -->
    <div class="metrics-section" *ngIf="hasResults() && metricsData.length > 0">
      <h3 class="section-title">Metrics Overview</h3>
      <div class="metrics-content">
        <div class="metrics-chart">
          <!-- Simple bar chart representation -->
          <div class="chart-container">
            <div *ngFor="let metric of metricsData" class="chart-bar">
              <div class="bar-label">{{ metric.name }}</div>
              <div class="bar-container">
                <div class="bar" [style.width.%]="metric.value * 100"></div>
                <div class="bar-value">{{ metric.value }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
      <div class="results-header">
        <h3 class="section-title">Evaluation Results</h3>
        <div
          class="results-actions"
          *ngIf="evaluation.status === EvaluationStatus.COMPLETED || evaluation.status === EvaluationStatus.FAILED || evaluation.status === EvaluationStatus.CANCELLED"
        ></div>
      </div>

      <!-- Results Loading State -->
      <div *ngIf="isLoadingResults" class="results-loading">
        <div class="spinner"></div>
        <p>Loading evaluation results...</p>
      </div>

      <!-- Results Error State -->
      <div *ngIf="resultsError && !isLoadingResults" class="results-error">
        <div class="error-icon">‚ùå</div>
        <p>{{ resultsError }}</p>
        <button class="retry-button" (click)="refreshResults()">
          Try Again
        </button>
      </div>

      <!-- No Results State -->
      <div
        *ngIf="!hasResults() && !isLoadingResults && !resultsError && evaluation.status === EvaluationStatus.COMPLETED"
        class="no-results"
      >
        <div class="empty-icon">üìä</div>
        <p>No results found for this evaluation.</p>
      </div>

      <!-- Results Not Ready State -->
      <div
        *ngIf="!hasResults() && !isLoadingResults && !resultsError && (evaluation.status === EvaluationStatus.PENDING || evaluation.status === EvaluationStatus.RUNNING)"
        class="results-pending"
      >
        <div class="pending-icon">‚è≥</div>
        <p>Results will be available once the evaluation is completed.</p>
      </div>

      <!-- Results Content -->
      <div *ngIf="hasResults() && !isLoadingResults" class="results-content">
        <div class="results-summary">
          <span class="results-count">Total Results: {{ totalResults }}</span>
        </div>

        <table class="results-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Sample ID</th>
              <th>Score</th>
              <th>Status</th>
              <th>Processing Time</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of getDisplayResults(); let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ result['dataset_sample_id'] || 'N/A' }}</td>
              <td>
                {{ result['overall_score'] ? (result['overall_score'] |
                number:'1.2-2') : 'N/A' }}
              </td>
              <!-- Pass/fail status column -->
              <td>
                <span
                  class="status-badge"
                  [ngClass]="result['passed'] ? 'completed' : 'failed'"
                  *ngIf="result['passed'] !== undefined"
                >
                  {{ result['passed'] ? 'PASS' : 'FAIL' }}
                </span>
                <span *ngIf="result['passed'] === undefined">N/A</span>
              </td>
              <td>
                {{ result['processing_time_ms'] ? (result['processing_time_ms']
                | number) + ' ms' : 'N/A' }}
              </td>
              <td>{{ formatDate(result['created_at']) }}</td>
              <td>
                <button class="view-button" (click)="viewResultDetails(result)">
                  View Details
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Result Details Modal -->
    <div
      class="modal-overlay"
      *ngIf="showResultDetails"
      (click)="closeResultDetails()"
    >
      <div class="enhanced-modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Result Details</h2>
          <div class="header-actions">
            <button class="export-button" (click)="exportResultDetails()">
              <span class="export-icon">üìä</span>
              Export
            </button>
            <button class="close-button" (click)="closeResultDetails()">
              √ó
            </button>
          </div>
        </div>

        <div class="modal-body" *ngIf="selectedResult">
          <!-- Tab Navigation -->
          <div class="tab-navigation">
            <button
              class="tab-button"
              [class.active]="activeResultTab === 'query'"
              (click)="setActiveResultTab('query')"
            >
              Query
            </button>
            <button
              class="tab-button"
              [class.active]="activeResultTab === 'context'"
              (click)="setActiveResultTab('context')"
            >
              Context
            </button>
            <button
              class="tab-button"
              [class.active]="activeResultTab === 'output'"
              (click)="setActiveResultTab('output')"
            >
              Output
            </button>
            <button
              class="tab-button"
              [class.active]="activeResultTab === 'metrics'"
              (click)="setActiveResultTab('metrics')"
            >
              Metrics
            </button>
          </div>

          <!-- Tab Content -->
          <div class="tab-content-container">
            <!-- Query Tab -->
            <div class="tab-content" *ngIf="activeResultTab === 'query'">
              <div class="content-section">
                <div class="section-header">
                  <h4>User Query</h4>
                  <button
                    class="copy-button"
                    (click)="copyToClipboard(getQueryText(selectedResult))"
                    title="Copy query"
                  >
                    üìã Copy
                  </button>
                </div>
                <div class="content-wrapper">
                  <div
                    class="formatted-content"
                    [class.collapsed]="!expandedSections.query"
                    [class.expanded]="expandedSections.query"
                  >
                    <p>{{ getQueryText(selectedResult) }}</p>
                  </div>
                  <div
                    class="expand-toggle"
                    *ngIf="shouldShowExpandButton(getQueryText(selectedResult))"
                    (click)="toggleSection('query')"
                  >
                    {{ expandedSections.query ? 'Show Less' : 'Show More' }}
                    <span class="character-count">
                      {{ getCharacterCountText(getQueryText(selectedResult),
                      expandedSections.query) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Context Tab -->
            <div class="tab-content" *ngIf="activeResultTab === 'context'">
              <div class="content-section">
                <div class="section-header">
                  <h4>Retrieved Context</h4>
                  <button
                    class="copy-button"
                    (click)="copyToClipboard(getContextText(selectedResult))"
                    title="Copy context"
                  >
                    üìã Copy
                  </button>
                </div>
                <div class="content-wrapper">
                  <div
                    class="formatted-content"
                    [class.collapsed]="!expandedSections.context"
                    [class.expanded]="expandedSections.context"
                  >
                    <div
                      *ngFor="let context of getContextArray(selectedResult); let i = index"
                      class="context-item"
                    >
                      <div class="context-header">
                        <span class="context-label">Context {{ i + 1 }}</span>
                        <span class="context-source" *ngIf="context.source"
                          >{{ context.source }}</span
                        >
                      </div>
                      <p>{{ context.content || context }}</p>
                    </div>
                  </div>
                  <div
                    class="expand-toggle"
                    *ngIf="shouldShowExpandButton(getContextText(selectedResult))"
                    (click)="toggleSection('context')"
                  >
                    {{ expandedSections.context ? 'Show Less' : 'Show More' }}
                    <span class="character-count">
                      {{ getCharacterCountText(getContextText(selectedResult),
                      expandedSections.context) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Output Tab -->
            <div class="tab-content" *ngIf="activeResultTab === 'output'">
              <div class="content-section">
                <div class="section-header">
                  <h4>Generated Response</h4>
                  <button
                    class="copy-button"
                    (click)="copyToClipboard(getOutputText(selectedResult))"
                    title="Copy response"
                  >
                    üìã Copy
                  </button>
                </div>
                <div class="content-wrapper">
                  <div
                    class="formatted-content"
                    [class.collapsed]="!expandedSections.output"
                    [class.expanded]="expandedSections.output"
                  >
                    <p>{{ getOutputText(selectedResult) }}</p>
                  </div>
                  <div
                    class="expand-toggle"
                    *ngIf="shouldShowExpandButton(getOutputText(selectedResult))"
                    (click)="toggleSection('output')"
                  >
                    {{ expandedSections.output ? 'Show Less' : 'Show More' }}
                    <span class="character-count">
                      {{ getCharacterCountText(getOutputText(selectedResult),
                      expandedSections.output) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Metrics Tab -->
            <div class="tab-content" *ngIf="activeResultTab === 'metrics'">
              <div class="content-section">
                <div class="section-header">
                  <h4>Evaluation Metrics</h4>
                  <div class="overall-score">
                    Overall Score:
                    <span class="score-value">
                      {{ selectedResult['overall_score'] ?
                      (selectedResult['overall_score'] | number:'1.2-2') : 'N/A'
                      }}
                    </span>
                  </div>
                </div>

                <!-- Metrics Table -->
                <div
                  class="metrics-table-container"
                  *ngIf="selectedResult['metric_scores'] && selectedResult['metric_scores'].length > 0"
                >
                  <table class="metrics-table">
                    <thead>
                      <tr>
                        <th>Metric</th>
                        <th>Score</th>
                        <th>Weight</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr
                        *ngFor="let metric of selectedResult['metric_scores']"
                      >
                        <td>
                          <div class="metric-name">{{ metric.name }}</div>
                          <div
                            class="metric-description"
                            *ngIf="metric.meta_info && metric.meta_info['description']"
                          >
                            {{ metric.meta_info['description'] }}
                          </div>
                          <!-- Add threshold info -->
                          <div
                            class="metric-threshold"
                            *ngIf="getMetricThreshold(metric)"
                          >
                            <small
                              ><strong>Threshold:</strong> {{
                              getMetricThreshold(metric) }}</small
                            >
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-bar">
                              <div
                                class="score-fill"
                                [style.width.%]="metric.value * 100"
                              ></div>
                            </div>
                            <span class="score-text"
                              >{{ metric.value | number:'1.2-2' }}</span
                            >
                          </div>
                        </td>
                        <td>{{ metric.weight | number:'1.2-2' }}</td>
                        <td>
                          <span
                            class="metric-status"
                            [ngClass]="getMetricStatusClass(metric)"
                          >
                            {{ getMetricStatus(metric) }}
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div
                  class="metrics-explanations"
                  *ngIf="selectedResult['metric_scores'] && selectedResult['metric_scores'].length > 0"
                >
                  <h5>Metric Explanations</h5>
                  <div
                    class="explanation-item"
                    *ngFor="let metric of selectedResult['metric_scores']"
                  >
                    <div class="explanation-header">
                      <span class="metric-name">{{ metric.name }}</span>
                      <span
                        class="metric-status"
                        [ngClass]="getMetricStatusClass(metric)"
                      >
                        {{ getMetricStatus(metric) }}
                      </span>
                    </div>
                    <div
                      class="explanation-text"
                      *ngIf="getMetricReason(metric)"
                    >
                      {{ getMetricReason(metric) }}
                    </div>
                  </div>
                </div>

                <!-- Raw Results (if needed) -->
                <div
                  class="raw-results-section"
                  *ngIf="selectedResult['raw_results']"
                >
                  <div class="section-header">
                    <h5>Raw Results</h5>
                    <button
                      class="copy-button"
                      (click)="copyToClipboard(getJsonString(selectedResult['raw_results']))"
                      title="Copy raw results"
                    >
                      üìã Copy JSON
                    </button>
                  </div>
                  <pre
                    class="raw-results-content"
                    [class.collapsed]="!expandedSections.raw"
                    [class.expanded]="expandedSections.raw"
                  >
{{ getJsonString(selectedResult['raw_results']) }}</pre
                  >
                  <div class="expand-toggle" (click)="toggleSection('raw')">
                    {{ expandedSections.raw ? 'Collapse' : 'Expand' }} Raw Data
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Summary Footer -->
          <div class="result-summary-footer">
            <div class="summary-item">
              <span class="summary-label">Processing Time:</span>
              <span class="summary-value">
                {{ selectedResult['processing_time_ms'] ?
                (selectedResult['processing_time_ms'] | number) + ' ms' : 'N/A'
                }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Status:</span>
              <span
                class="summary-value status-badge"
                [class.pass]="selectedResult['passed']"
                [class.fail]="selectedResult['passed'] === false"
              >
                {{ selectedResult['passed'] === undefined ? 'N/A' :
                (selectedResult['passed'] ? 'PASS' : 'FAIL') }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Sample ID:</span>
              <span class="summary-value"
                >{{ selectedResult['dataset_sample_id'] || 'N/A' }}</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
