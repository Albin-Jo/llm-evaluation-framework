<div class="visualization-container" #chartContainer>
  <!-- Chart Title -->
  <div class="chart-header" *ngIf="hasData()">
    <h3 class="chart-title">{{ getChartTitle() }}</h3>
  </div>

  <!-- No Data Message -->
  <div *ngIf="!hasData()" class="no-data-message">
    <div class="no-data-icon">ðŸ“Š</div>
    <h3>No Visualization Data Available</h3>
    <p>Run the comparison to see visualizations of the results.</p>
  </div>

  <!-- Chart Area -->
  <div class="chart-container" *ngIf="hasData()">
    <svg
      [attr.width]="svgWidth"
      [attr.height]="svgHeight"
      class="chart-svg"
      [attr.viewBox]="getViewBox()"
      preserveAspectRatio="xMidYMid meet"
    >
      <!-- Chart Title -->
      <text
        [attr.x]="svgWidth / 2"
        [attr.y]="30"
        text-anchor="middle"
        class="chart-title-text"
      >
        {{ getChartTitle() }}
      </text>

      <!-- Radar Chart -->
      <g *ngIf="visualizationType === 'radar'">
        <!-- Grid circles -->
        <circle
          *ngFor="let circle of getRadarGridCircles()"
          [attr.cx]="circle.cx"
          [attr.cy]="circle.cy"
          [attr.r]="circle.r"
          class="grid-circle"
        ></circle>

        <!-- Grid labels -->
        <g *ngFor="let circle of getRadarGridCircles(); let i = index">
          <text
            [attr.x]="circle.cx + circle.r"
            [attr.y]="circle.cy - 5"
            class="grid-label"
            text-anchor="start"
          >
            {{ ((i + 1) * 0.2).toFixed(1) }}
          </text>
        </g>

        <!-- Axis lines -->
        <line
          *ngFor="let line of getRadarAxisLines()"
          [attr.x1]="line.x1"
          [attr.y1]="line.y1"
          [attr.x2]="line.x2"
          [attr.y2]="line.y2"
          class="axis-line"
        ></line>

        <!-- Data polygons -->
        <g *ngFor="let dataset of processedData?.datasets; let i = index">
          <path
            [attr.d]="getRadarPath(i)"
            [attr.stroke]="dataset.borderColor"
            [attr.fill]="dataset.backgroundColor"
            [attr.stroke-width]="2"
            class="data-polygon"
            [attr.opacity]="0.7"
          ></path>
        </g>

        <!-- Axis labels -->
        <g *ngFor="let label of getRadarLabelPositions()">
          <text
            [attr.x]="label.x"
            [attr.y]="label.y"
            [attr.text-anchor]="
              label.x > margin.left + innerWidth / 2
                ? 'start'
                : label.x < margin.left + innerWidth / 2
                ? 'end'
                : 'middle'
            "
            [attr.alignment-baseline]="
              label.y > margin.top + innerHeight / 2
                ? 'hanging'
                : label.y < margin.top + innerHeight / 2
                ? 'baseline'
                : 'middle'
            "
            class="axis-label"
          >
            {{ label.label }}
          </text>
        </g>
      </g>

      <!-- Bar Chart -->
      <g *ngIf="visualizationType === 'bar'">
        <!-- Y-axis -->
        <line
          [attr.x1]="margin.left"
          [attr.y1]="margin.top"
          [attr.x2]="margin.left"
          [attr.y2]="margin.top + innerHeight"
          stroke="#333"
          stroke-width="2"
        ></line>

        <!-- Y-axis ticks and labels -->
        <g *ngFor="let tick of getYAxisTicks()">
          <line
            [attr.x1]="tick.x1"
            [attr.y1]="tick.y1"
            [attr.x2]="tick.x2"
            [attr.y2]="tick.y2"
            stroke="#333"
            stroke-width="1"
          ></line>
          <text
            [attr.x]="tick.x1 - 8"
            [attr.y]="tick.y1"
            text-anchor="end"
            alignment-baseline="middle"
            class="axis-label"
          >
            {{ tick.label }}
          </text>
        </g>

        <!-- Horizontal grid lines -->
        <g *ngFor="let tick of getYAxisTicks()">
          <line
            [attr.x1]="margin.left"
            [attr.y1]="tick.y1"
            [attr.x2]="margin.left + innerWidth"
            [attr.y2]="tick.y1"
            stroke="#f0f0f0"
            stroke-width="1"
          ></line>
        </g>

        <!-- X-axis -->
        <line
          [attr.x1]="margin.left"
          [attr.y1]="margin.top + innerHeight"
          [attr.x2]="margin.left + innerWidth"
          [attr.y2]="margin.top + innerHeight"
          stroke="#333"
          stroke-width="2"
        ></line>

        <!-- Bars -->
        <g *ngFor="let bar of getBarChartRects(); let i = index">
          <rect
            [attr.x]="bar.x"
            [attr.y]="bar.y"
            [attr.width]="bar.width"
            [attr.height]="bar.height"
            [attr.fill]="bar.color"
            class="bar"
            stroke="white"
            stroke-width="1"
          ></rect>

          <!-- Bar value labels -->
          <text
            *ngIf="bar.height > 20"
            [attr.x]="bar.x + bar.width / 2"
            [attr.y]="bar.y + 15"
            text-anchor="middle"
            fill="white"
            class="bar-label"
            font-size="10"
            font-weight="bold"
          >
            {{ bar.value.toFixed(3) }}
          </text>
        </g>

        <!-- X-axis labels -->
        <g *ngFor="let label of getXAxisLabels()">
          <text
            [attr.x]="label.x"
            [attr.y]="label.y"
            text-anchor="middle"
            alignment-baseline="hanging"
            class="axis-label"
            [attr.transform]="'rotate(-45, ' + label.x + ', ' + label.y + ')'"
          >
            {{ label.label }}
          </text>
        </g>

        <!-- Difference line -->
        <g *ngIf="processedData?.datasets?.length > 2">
          <!-- Zero reference line -->
          <line
            [attr.x1]="margin.left"
            [attr.y1]="margin.top + innerHeight / 2"
            [attr.x2]="margin.left + innerWidth"
            [attr.y2]="margin.top + innerHeight / 2"
            stroke="#ccc"
            stroke-width="1"
            stroke-dasharray="4,4"
          ></line>

          <!-- Difference line -->
          <polyline
            [attr.points]="getDifferenceLine().points"
            [attr.stroke]="getDifferenceLine().color"
            fill="none"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"
          ></polyline>
        </g>
      </g>

      <!-- Line Chart -->
      <g *ngIf="visualizationType === 'line'">
        <!-- Y-axis -->
        <line
          [attr.x1]="margin.left"
          [attr.y1]="margin.top"
          [attr.x2]="margin.left"
          [attr.y2]="margin.top + innerHeight"
          stroke="#333"
          stroke-width="2"
        ></line>

        <!-- Y-axis ticks and labels -->
        <g *ngFor="let tick of getYAxisTicks()">
          <line
            [attr.x1]="tick.x1"
            [attr.y1]="tick.y1"
            [attr.x2]="tick.x2"
            [attr.y2]="tick.y2"
            stroke="#333"
            stroke-width="1"
          ></line>
          <text
            [attr.x]="tick.x1 - 8"
            [attr.y]="tick.y1"
            text-anchor="end"
            alignment-baseline="middle"
            class="axis-label"
          >
            {{ tick.label }}
          </text>
        </g>

        <!-- Horizontal grid lines -->
        <g *ngFor="let tick of getYAxisTicks()">
          <line
            [attr.x1]="margin.left"
            [attr.y1]="tick.y1"
            [attr.x2]="margin.left + innerWidth"
            [attr.y2]="tick.y1"
            stroke="#f0f0f0"
            stroke-width="1"
          ></line>
        </g>

        <!-- X-axis -->
        <line
          [attr.x1]="margin.left"
          [attr.y1]="margin.top + innerHeight"
          [attr.x2]="margin.left + innerWidth"
          [attr.y2]="margin.top + innerHeight"
          stroke="#333"
          stroke-width="2"
        ></line>

        <!-- X-axis labels -->
        <g *ngFor="let label of getXAxisLabels()">
          <text
            [attr.x]="label.x"
            [attr.y]="label.y"
            text-anchor="middle"
            alignment-baseline="hanging"
            class="axis-label"
            [attr.transform]="
              'rotate(-45, ' + label.x + ', ' + (label.y + 10) + ')'
            "
          >
            {{ label.label }}
          </text>
        </g>

        <!-- Lines for each dataset -->
        <g *ngFor="let dataset of processedData?.datasets; let i = index">
          <path
            [attr.d]="getLineChartPath(i)"
            [attr.stroke]="dataset.borderColor"
            fill="none"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="line-path"
          ></path>

          <!-- Data points -->
          <g *ngFor="let point of getDataPoints(i)">
            <circle
              [attr.cx]="point.x"
              [attr.cy]="point.y"
              r="5"
              [attr.fill]="dataset.borderColor"
              stroke="white"
              stroke-width="2"
              class="data-point"
            ></circle>

            <!-- Value labels on hover -->
            <text
              [attr.x]="point.x"
              [attr.y]="point.y - 10"
              text-anchor="middle"
              class="point-label"
              fill="#666"
              font-size="10"
            >
              {{ point.value.toFixed(3) }}
            </text>
          </g>
        </g>
      </g>
    </svg>
  </div>

  <!-- Legend -->
  <div *ngIf="hasData()" class="chart-legend">
    <div class="legend-title">Legend</div>
    <div
      *ngFor="let dataset of processedData?.datasets; let i = index"
      class="legend-item"
    >
      <div
        class="legend-color"
        [style.background-color]="
          dataset.backgroundColor || dataset.borderColor
        "
      ></div>
      <div class="legend-label">{{ dataset.label }}</div>
    </div>
  </div>

  <!-- Chart Statistics -->
  <div *ngIf="hasData() && metricDifferences.length > 0" class="chart-stats">
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-label">Metrics Analyzed:</span>
        <span class="stat-value">{{ processedData?.labels?.length || 0 }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Evaluations:</span>
        <span class="stat-value">{{
          processedData?.datasets?.length || 0
        }}</span>
      </div>
      <div class="stat-item" *ngIf="processedData?.maxValue">
        <span class="stat-label">Max Value:</span>
        <span class="stat-value">{{ processedData.maxValue.toFixed(3) }}</span>
      </div>
      <div class="stat-item" *ngIf="processedData?.minValue">
        <span class="stat-label">Min Value:</span>
        <span class="stat-value">{{ processedData.minValue.toFixed(3) }}</span>
      </div>
    </div>
  </div>
</div>
