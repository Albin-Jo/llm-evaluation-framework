<div class="comparison-detail-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="back-navigation">
      <a routerLink="/app/comparisons" class="back-link">
        <i class="icon icon-arrow-left"></i>
        <span>Back to Comparisons</span>
      </a>
    </div>

    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title" *ngIf="comparison">{{ comparison.name }}</h1>
          <p class="page-description" *ngIf="comparison?.description">
            {{ comparison?.description }}
          </p>
          <div class="status-container" *ngIf="comparison">
            <span
              class="status-badge"
              [ngClass]="getStatusClass(comparison.status)"
            >
              <i class="icon icon-circle"></i>
              {{ comparison.status | titlecase }}
            </span>
            <span class="creation-date">
              Created {{ formatDate(comparison.created_at) }}
            </span>
          </div>
        </div>

        <div class="action-buttons" *ngIf="comparison">
          <button
            *ngIf="canRunComparison()"
            class="btn btn-primary"
            (click)="runComparison()"
          >
            <i class="icon icon-play"></i>
            Run Comparison
          </button>
          <button class="btn btn-outline" (click)="editComparison()">
            <i class="icon icon-edit"></i>
            Edit
          </button>
          <button class="btn btn-danger" (click)="deleteComparison()">
            <i class="icon icon-trash"></i>
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p class="loading-text">Loading comparison details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <div class="error-icon">
      <i class="icon icon-alert-circle"></i>
    </div>
    <p class="error-message">{{ error }}</p>
    <button class="btn btn-outline" (click)="loadComparison(comparisonId)">
      <i class="icon icon-refresh"></i>
      Try Again
    </button>
  </div>

  <!-- Comparison Content -->
  <div *ngIf="comparison && !isLoading" class="comparison-content">
    <!-- Enhanced Summary Banner -->
    <div class="summary-banner" *ngIf="hasResults() && summaryData">
      <div class="performance-overview">
        <div
          class="performance-indicator"
          [ngClass]="summaryData.overallStatus"
        >
          <div class="indicator-icon">
            <i
              class="icon"
              [ngClass]="{
                 'icon-trending-up': summaryData.overallStatus === 'improved',
                 'icon-trending-down': summaryData.overallStatus === 'regressed',
                 'icon-minus': summaryData.overallStatus === 'unchanged'
               }"
            ></i>
          </div>
          <div class="indicator-content">
            <div class="indicator-value">
              {{ formatPercentage(summaryData.overallPerformanceChange) }}
            </div>
            <div class="indicator-label">Overall Performance</div>
          </div>
        </div>

        <div class="performance-details">
          <div class="detail-item">
            <div class="detail-value">
              {{ summaryData.improvedMetrics }}/{{ summaryData.totalMetrics }}
            </div>
            <div class="detail-label">Metrics Improved</div>
          </div>
          <div class="detail-item">
            <div class="detail-value">{{ summaryData.samplesAnalyzed }}</div>
            <div class="detail-label">Samples Analyzed</div>
          </div>
          <div class="detail-item">
            <div class="detail-value">{{ summaryData.statisticalPower }}</div>
            <div class="detail-label">Statistical Power</div>
          </div>
        </div>
      </div>

      <!-- Key Insights -->
      <div
        class="key-insights"
        *ngIf="topImprovements.length > 0 || topRegressions.length > 0"
      >
        <div class="insights-header">
          <h3>Key Changes</h3>
        </div>
        <div class="insights-content">
          <div class="improvements" *ngIf="topImprovements.length > 0">
            <h4><i class="icon icon-trending-up"></i> Top Improvements</h4>
            <div class="change-list">
              <div
                *ngFor="let improvement of topImprovements"
                class="change-item improved"
              >
                <span class="metric-name">{{ improvement.metric }}</span>
                <span class="metric-change"
                  >{{ formatPercentage(improvement.value) }}</span
                >
                <span
                  class="impact-badge"
                  [ngClass]="getImpactClass(improvement.value)"
                >
                  {{ improvement.impact }}
                </span>
              </div>
            </div>
          </div>

          <div class="regressions" *ngIf="topRegressions.length > 0">
            <h4><i class="icon icon-trending-down"></i> Top Regressions</h4>
            <div class="change-list">
              <div
                *ngFor="let regression of topRegressions"
                class="change-item regressed"
              >
                <span class="metric-name">{{ regression.metric }}</span>
                <span class="metric-change"
                  >{{ formatPercentage(regression.value) }}</span
                >
                <span
                  class="impact-badge"
                  [ngClass]="getImpactClass(getAbsoluteValue(regression.value))"
                >
                  {{ regression.impact }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Evaluation Comparison Cards -->
    <div class="evaluation-cards">
      <!-- Evaluation A Card -->
      <div class="evaluation-card" *ngIf="evaluationA">
        <div class="card-header">
          <div class="evaluation-indicator eval-a">A</div>
          <div class="evaluation-info">
            <h3 class="evaluation-name">{{ evaluationA.name }}</h3>
            <p class="evaluation-method">
              {{ evaluationA.method | uppercase }}
            </p>
          </div>
          <div class="evaluation-score">
            <div class="score-value">
              {{ formatNumber(evaluationA.overallScore, 3) }}
            </div>
            <div class="score-label">Overall Score</div>
          </div>
        </div>

        <div class="card-content">
          <div class="info-grid">
            <div class="info-item">
              <i class="icon icon-cpu"></i>
              <div class="info-content">
                <div class="info-label">Agent</div>
                <div class="info-value">{{ evaluationA.agentName }}</div>
              </div>
            </div>
            <div class="info-item">
              <i class="icon icon-database"></i>
              <div class="info-content">
                <div class="info-label">Dataset</div>
                <div class="info-value">{{ evaluationA.datasetName }}</div>
              </div>
            </div>
            <div class="info-item">
              <i class="icon icon-file-text"></i>
              <div class="info-content">
                <div class="info-label">Prompt</div>
                <div class="info-value">{{ evaluationA.promptName }}</div>
              </div>
            </div>
            <div class="info-item">
              <i class="icon icon-hash"></i>
              <div class="info-content">
                <div class="info-label">Samples</div>
                <div class="info-value">{{ evaluationA.processedItems }}</div>
              </div>
            </div>
            <div class="info-item" *ngIf="evaluationA.duration">
              <i class="icon icon-clock"></i>
              <div class="info-content">
                <div class="info-label">Duration</div>
                <div class="info-value">{{ evaluationA.duration }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button
            class="btn btn-outline btn-sm"
            (click)="viewEvaluation(evaluationA.id)"
          >
            <i class="icon icon-external-link"></i>
            View Details
          </button>
        </div>
      </div>

      <!-- VS Indicator -->
      <div class="vs-indicator">
        <div class="vs-circle">VS</div>
      </div>

      <!-- Evaluation B Card -->
      <div class="evaluation-card" *ngIf="evaluationB">
        <div class="card-header">
          <div class="evaluation-indicator eval-b">B</div>
          <div class="evaluation-info">
            <h3 class="evaluation-name">{{ evaluationB.name }}</h3>
            <p class="evaluation-method">
              {{ evaluationB.method | uppercase }}
            </p>
          </div>
          <div class="evaluation-score">
            <div class="score-value">
              {{ formatNumber(evaluationB.overallScore, 3) }}
            </div>
            <div class="score-label">Overall Score</div>
          </div>
        </div>

        <div class="card-content">
          <div class="info-grid">
            <div class="info-item">
              <i class="icon icon-cpu"></i>
              <div class="info-content">
                <div class="info-label">Agent</div>
                <div class="info-value">{{ evaluationB.agentName }}</div>
              </div>
            </div>
            <div class="info-item">
              <i class="icon icon-database"></i>
              <div class="info-content">
                <div class="info-label">Dataset</div>
                <div class="info-value">{{ evaluationB.datasetName }}</div>
              </div>
            </div>
            <div class="info-item">
              <i class="icon icon-file-text"></i>
              <div class="info-content">
                <div class="info-label">Prompt</div>
                <div class="info-value">{{ evaluationB.promptName }}</div>
              </div>
            </div>
            <div class="info-item">
              <i class="icon icon-hash"></i>
              <div class="info-content">
                <div class="info-label">Samples</div>
                <div class="info-value">{{ evaluationB.processedItems }}</div>
              </div>
            </div>
            <div class="info-item" *ngIf="evaluationB.duration">
              <i class="icon icon-clock"></i>
              <div class="info-content">
                <div class="info-label">Duration</div>
                <div class="info-value">{{ evaluationB.duration }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button
            class="btn btn-outline btn-sm"
            (click)="viewEvaluation(evaluationB.id)"
          >
            <i class="icon icon-external-link"></i>
            View Details
          </button>
        </div>
      </div>
    </div>

    <!-- Narrative Insights -->
    <div class="narrative-insights" *ngIf="comparison.narrative_insights">
      <div class="insights-header">
        <i class="icon icon-lightbulb"></i>
        <h3>Analysis Summary</h3>
      </div>
      <div class="insights-content">
        <p class="narrative-text">{{ comparison.narrative_insights }}</p>
      </div>
    </div>

    <!-- Tabbed Content -->
    <div class="tabbed-content">
      <div class="tab-navigation">
        <button
          *ngFor="let tab of tabs; let i = index"
          class="tab-button"
          [class.active]="selectedTabIndex === i"
          (click)="selectTab(i)"
        >
          <i class="icon" [ngClass]="'icon-' + tab.icon"></i>
          <span>{{ tab.label }}</span>
        </button>
      </div>

      <div class="tab-content">
        <!-- Overview Tab -->
        <div *ngIf="selectedTabIndex === 0" class="tab-panel">
          <div class="overview-content" *ngIf="hasResults()">
            <div class="metrics-summary">
              <h3>Metrics Overview</h3>
              <div class="summary-grid">
                <div class="summary-card improved">
                  <div class="card-icon">
                    <i class="icon icon-trending-up"></i>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ summaryData?.improvedMetrics || 0 }}
                    </div>
                    <div class="card-label">Improved</div>
                  </div>
                </div>
                <div class="summary-card regressed">
                  <div class="card-icon">
                    <i class="icon icon-trending-down"></i>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ summaryData?.regressedMetrics || 0 }}
                    </div>
                    <div class="card-label">Regressed</div>
                  </div>
                </div>
                <div class="summary-card unchanged">
                  <div class="card-icon">
                    <i class="icon icon-minus"></i>
                  </div>
                  <div class="card-content">
                    <div class="card-value">
                      {{ summaryData?.unchangedMetrics || 0 }}
                    </div>
                    <div class="card-label">Unchanged</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="configuration-info">
              <h3>Configuration</h3>
              <div class="config-grid">
                <div class="config-item">
                  <div class="config-label">Threshold</div>
                  <div class="config-value">
                    {{ comparison.config?.['threshold'] || '0.05' }}
                  </div>
                </div>
                <div class="config-item">
                  <div class="config-label">Normalized Scores</div>
                  <div class="config-value">
                    {{ comparison.config?.['normalize_scores'] ? 'Yes' : 'No' }}
                  </div>
                </div>
                <div class="config-item">
                  <div class="config-label">Detailed Analysis</div>
                  <div class="config-value">
                    {{ comparison.config?.['detailed_analysis'] ? 'Yes' : 'No'
                    }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!hasResults()" class="empty-state">
            <div class="empty-icon">
              <i class="icon icon-analytics"></i>
            </div>
            <h3>No Analysis Available</h3>
            <p>Run the comparison to see detailed analysis.</p>
            <button
              *ngIf="canRunComparison()"
              class="btn btn-primary"
              (click)="runComparison()"
            >
              <i class="icon icon-play"></i>
              Run Comparison
            </button>
          </div>
        </div>

        <!-- Metrics Analysis Tab -->
        <div *ngIf="selectedTabIndex === 1" class="tab-panel">
          <div
            class="metrics-analysis"
            *ngIf="hasResults() && metricDifferences.length > 0"
          >
            <div class="metrics-table-container">
              <table class="metrics-table">
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th>Evaluation A</th>
                    <th>Evaluation B</th>
                    <th>Difference</th>
                    <th>Change (%)</th>
                    <th>Impact</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let metric of metricDifferences"
                    [ngClass]="getMetricRowClass(metric)"
                  >
                    <td class="metric-name">
                      {{ getFormattedMetricName(metric.metric_name) }}
                    </td>
                    <td class="metric-value">
                      {{ formatNumber(metric.evaluation_a_value) }}
                    </td>
                    <td class="metric-value">
                      {{ formatNumber(metric.evaluation_b_value) }}
                    </td>
                    <td
                      class="metric-difference"
                      [ngClass]="getDifferenceClass(metric)"
                    >
                      {{ formatNumber(metric.absolute_difference, 4) }}
                    </td>
                    <td
                      class="metric-percentage"
                      [ngClass]="getDifferenceClass(metric)"
                    >
                      {{ formatPercentage(metric.percentage_change) }}
                    </td>
                    <td class="metric-impact">
                      <span
                        class="impact-badge"
                        [ngClass]="getImpactClass(getAbsoluteValue(metric.percentage_change || 0))"
                      >
                        {{ getImpactLevelForValue(metric.percentage_change || 0)
                        }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div
            *ngIf="!hasResults() || metricDifferences.length === 0"
            class="empty-state"
          >
            <div class="empty-icon">
              <i class="icon icon-trending-up"></i>
            </div>
            <h3>No Metrics Analysis Available</h3>
            <p>Run the comparison to see detailed metrics analysis.</p>
            <button
              *ngIf="canRunComparison()"
              class="btn btn-primary"
              (click)="runComparison()"
            >
              <i class="icon icon-play"></i>
              Run Comparison
            </button>
          </div>
        </div>

        <!-- Visualizations Tab -->
        <div *ngIf="selectedTabIndex === 2" class="tab-panel">
          <div class="visualization-section" *ngIf="hasResults()">
            <div class="visualization-controls">
              <div class="control-group">
                <label class="control-label">Chart Type:</label>
                <div class="chart-type-buttons">
                  <button
                    class="chart-button"
                    [class.active]="selectedVisualization === 'radar'"
                    (click)="selectVisualization('radar')"
                  >
                    <i class="icon icon-target"></i>
                    Radar
                  </button>
                  <button
                    class="chart-button"
                    [class.active]="selectedVisualization === 'bar'"
                    (click)="selectVisualization('bar')"
                  >
                    <i class="icon icon-bar-chart"></i>
                    Bar
                  </button>
                  <button
                    class="chart-button"
                    [class.active]="selectedVisualization === 'line'"
                    (click)="selectVisualization('line')"
                  >
                    <i class="icon icon-trending-up"></i>
                    Line
                  </button>
                </div>
              </div>
            </div>

            <div class="chart-container">
              <div *ngIf="isLoadingVisualization" class="chart-loading">
                <div class="spinner"></div>
                <p>Loading chart...</p>
              </div>

              <app-comparison-visualization
                *ngIf="!isLoadingVisualization && visualizationData"
                [visualizationType]="selectedVisualization"
                [visualizationData]="visualizationData"
                [metricDifferences]="metricDifferences"
              ></app-comparison-visualization>
            </div>
          </div>

          <div *ngIf="!hasResults()" class="empty-state">
            <div class="empty-icon">
              <i class="icon icon-bar-chart"></i>
            </div>
            <h3>No Visualization Data Available</h3>
            <p>Run the comparison to see visual analysis.</p>
            <button
              *ngIf="canRunComparison()"
              class="btn btn-primary"
              (click)="runComparison()"
            >
              <i class="icon icon-play"></i>
              Run Comparison
            </button>
          </div>
        </div>

        <!-- Sample Analysis Tab -->
        <div *ngIf="selectedTabIndex === 3" class="tab-panel">
          <div
            class="sample-analysis"
            *ngIf="hasResults() && sampleDifferences.length > 0"
          >
            <div class="sample-controls">
              <div class="filter-controls">
                <div class="control-group">
                  <label class="control-label">Filter:</label>
                  <select
                    class="control-select"
                    [(ngModel)]="sampleFilter"
                    (change)="filterSamples()"
                  >
                    <option value="all">All Samples</option>
                    <option value="improved">Improved Only</option>
                    <option value="regressed">Regressed Only</option>
                    <option value="unchanged">Unchanged Only</option>
                  </select>
                </div>
                <div class="control-group">
                  <label class="control-label">Sort by:</label>
                  <select
                    class="control-select"
                    [(ngModel)]="sampleSort"
                    (change)="sortSamples()"
                  >
                    <option value="difference">Difference</option>
                    <option value="id">Sample ID</option>
                    <option value="score_a">Score A</option>
                    <option value="score_b">Score B</option>
                  </select>
                </div>
              </div>

              <div class="sample-stats">
                <div class="stat-item">
                  <div class="stat-value">{{ filteredSamples.length }}</div>
                  <div class="stat-label">Showing</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">{{ sampleDifferences.length }}</div>
                  <div class="stat-label">Total</div>
                </div>
              </div>
            </div>

            <div
              class="sample-table-container"
              *ngIf="filteredSamples.length > 0"
            >
              <table class="sample-table">
                <thead>
                  <tr>
                    <th>Sample ID</th>
                    <th>Score A</th>
                    <th>Score B</th>
                    <th>Difference</th>
                    <th>Change (%)</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let sample of filteredSamples; let i = index"
                    [ngClass]="getSampleStatusClass(sample.status)"
                  >
                    <td class="sample-id">{{ sample.sample_id }}</td>
                    <td class="sample-score">
                      {{ formatNumber(sample.evaluation_a_score) }}
                    </td>
                    <td class="sample-score">
                      {{ formatNumber(sample.evaluation_b_score) }}
                    </td>
                    <td
                      class="sample-difference"
                      [ngClass]="getSampleDifferenceClass(sample)"
                    >
                      {{ formatNumber(sample.absolute_difference, 4) }}
                    </td>
                    <td
                      class="sample-percentage"
                      [ngClass]="getSampleDifferenceClass(sample)"
                    >
                      {{ formatPercentage(sample.percentage_difference) }}
                    </td>
                    <td>
                      <span
                        class="status-badge"
                        [ngClass]="getSampleStatusClass(sample.status)"
                      >
                        {{ sample.status | titlecase }}
                      </span>
                    </td>
                    <td>
                      <button
                        class="btn btn-outline btn-sm"
                        (click)="viewSampleDetails(sample)"
                      >
                        <i class="icon icon-eye"></i>
                        View
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div *ngIf="filteredSamples.length === 0" class="empty-state">
              <div class="empty-icon">
                <i class="icon icon-filter"></i>
              </div>
              <h3>No Samples Match Filter</h3>
              <p>Try adjusting your filter criteria.</p>
            </div>
          </div>

          <div
            *ngIf="!hasResults() || sampleDifferences.length === 0"
            class="empty-state"
          >
            <div class="empty-icon">
              <i class="icon icon-list"></i>
            </div>
            <h3>No Sample Analysis Available</h3>
            <p>Run the comparison to see sample-by-sample analysis.</p>
            <button
              *ngIf="canRunComparison()"
              class="btn btn-primary"
              (click)="runComparison()"
            >
              <i class="icon icon-play"></i>
              Run Comparison
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sample Details Modal -->
  <div
    class="modal-overlay"
    *ngIf="showSampleDetails"
    (click)="closeSampleDetails()"
  >
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Sample Analysis</h2>
        <button class="modal-close" (click)="closeSampleDetails()">
          <i class="icon icon-x"></i>
        </button>
      </div>

      <div class="modal-content" *ngIf="selectedSample">
        <div class="sample-meta">
          <div class="meta-item">
            <div class="meta-label">Sample ID</div>
            <div class="meta-value">{{ selectedSample.sample_id }}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Status</div>
            <div class="meta-value">
              <span
                class="status-badge"
                [ngClass]="getSampleStatusClass(selectedSample.status)"
              >
                {{ selectedSample.status | titlecase }}
              </span>
            </div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Score Difference</div>
            <div
              class="meta-value"
              [ngClass]="getSampleDifferenceClass(selectedSample)"
            >
              {{ formatNumber(selectedSample.absolute_difference, 4) }} ({{
              formatPercentage(selectedSample.percentage_difference) }})
            </div>
          </div>
        </div>

        <div class="sample-scores">
          <div class="score-comparison">
            <div class="score-item">
              <div class="score-header">
                <div class="evaluation-indicator eval-a">A</div>
                <div class="score-label">
                  {{ evaluationA?.name || 'Evaluation A' }}
                </div>
              </div>
              <div class="score-value">
                {{ formatNumber(selectedSample.evaluation_a_score, 4) }}
              </div>
            </div>

            <div class="score-divider">
              <i class="icon icon-arrow-right"></i>
            </div>

            <div class="score-item">
              <div class="score-header">
                <div class="evaluation-indicator eval-b">B</div>
                <div class="score-label">
                  {{ evaluationB?.name || 'Evaluation B' }}
                </div>
              </div>
              <div class="score-value">
                {{ formatNumber(selectedSample.evaluation_b_score, 4) }}
              </div>
            </div>
          </div>
        </div>

        <div
          class="sample-data"
          *ngIf="selectedSample.input_data || selectedSample.evaluation_a_output || selectedSample.evaluation_b_output"
        >
          <div class="data-section" *ngIf="selectedSample.input_data">
            <h4>Input Data</h4>
            <pre class="data-content">
{{ formatJsonData(selectedSample.input_data) }}</pre
            >
          </div>

          <div class="data-section" *ngIf="selectedSample.evaluation_a_output">
            <h4>Evaluation A Output</h4>
            <pre class="data-content">
{{ formatJsonData(selectedSample.evaluation_a_output) }}</pre
            >
          </div>

          <div class="data-section" *ngIf="selectedSample.evaluation_b_output">
            <h4>Evaluation B Output</h4>
            <pre class="data-content">
{{ formatJsonData(selectedSample.evaluation_b_output) }}</pre
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
